From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: kyngs <kyngs@users.noreply.github.com>
Date: Sun, 19 May 2024 19:17:07 +0200
Subject: [PATCH] Fix chunks not getting serialized when reloaded.


diff --git a/src/main/java/com/infernalsuite/asp/level/SlimeChunkLevel.java b/src/main/java/com/infernalsuite/asp/level/SlimeChunkLevel.java
index 0d218911fb8be1bc5272b6e291ec60404306c831..a92d17b5c6a7c8427ecbdf56a9c2a0c1b66978e4 100644
--- a/src/main/java/com/infernalsuite/asp/level/SlimeChunkLevel.java
+++ b/src/main/java/com/infernalsuite/asp/level/SlimeChunkLevel.java
@@ -24,4 +24,10 @@ public class SlimeChunkLevel extends LevelChunk {
         super.unloadCallback();
         this.inMemoryWorld.unload(this);
     }
+
+    @Override
+    public void loadCallback() {
+        super.loadCallback();
+        this.inMemoryWorld.ensureChunkMarkedAsLoaded(this);
+    }
 }
\ No newline at end of file
diff --git a/src/main/java/com/infernalsuite/asp/level/SlimeInMemoryWorld.java b/src/main/java/com/infernalsuite/asp/level/SlimeInMemoryWorld.java
index 03d9c9448d7c010f5daf69cabce6bf861ea203aa..8fcb0ab62ce098a07cc5a0d3b481a45e9f75e161 100644
--- a/src/main/java/com/infernalsuite/asp/level/SlimeInMemoryWorld.java
+++ b/src/main/java/com/infernalsuite/asp/level/SlimeInMemoryWorld.java
@@ -220,7 +220,7 @@ public class SlimeInMemoryWorld implements SlimeWorld, SlimeWorldInstance {
                     } else {
                         chunk = safeNmsChunkWrapper.getWrapper().getChunk();
                     }
-                } else if  (clonedChunk instanceof NMSSlimeChunk nmsSlimeChunk) {
+                } else if (clonedChunk instanceof NMSSlimeChunk nmsSlimeChunk) {
                     chunk = nmsSlimeChunk.getChunk();
                 }
 
@@ -278,4 +278,10 @@ public class SlimeInMemoryWorld implements SlimeWorld, SlimeWorldInstance {
     public @NotNull PersistentDataContainer getPersistentDataContainer() {
         return this.extraPDC;
     }
+
+    public void ensureChunkMarkedAsLoaded(SlimeChunkLevel chunk) {
+        if (chunkStorage.get(new ChunkPos(chunk.locX, chunk.locZ)) instanceof SlimeChunkSkeleton skeleton) {
+            chunkStorage.put(new ChunkPos(chunk.locX, chunk.locZ), new NMSSlimeChunk(chunk, skeleton));
+        }
+    }
 }
